{% extends 'main.html' %} 
{% load i18n static %}
{% block header %}
    
{% endblock header %} 
    
{% block content %}


        <div class="page-breadcrumb">
          <div class="row">
            <div class="col-10 d-flex no-block align-items-center">
              <h4 class="page-title">Users</h4>
              <div class="ms-auto text-end">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Staff</a></li>
                    <li class="breadcrumb-item active" aria-current="page">
                      List
                    </li>
                  </ol>
                </nav>
              </div>
            </div>

            <div class="col-2  align-right">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#createUser">
                    <i class="mdi mdi-plus fs-6"></i> New User
                </button>
            </div>
          </div>
        </div>

        
        <div class="container-fluid">
            
                <div class="card shadow mb-4">
                    <div class="card-header py-3_xxx">
                        <div class="d-sm-flex align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">Users</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <div class="row">
                                <div class="col-sm-12 text-center loader">
                                    <img class="loading" src="../media/loading.svg" style="width:10%;" alt="">
                                </div>
                            </div>
                            <table class="table table-striped table-bordered userDatatable" id="userDatatable" width="100%" cellspacing="0">
                                <thead>
                                    <th>Email</th>
                                    <th>User Type</th>
                                    <th>Date Joined</th>
                                    <th>Last Login</th>
                                    <th>Action</th>                                
                                </thead>
                                <tbody class="">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                


        </div>
        

        <div class="modal fade" id="ViewUserModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content p-3">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">User Profile </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-sm-12 text-center loader">
                                <img class="loading" src="../media/loading.svg" style="width:10%;" alt="">
                            </div>
                        </div>
                        <div class="row">
                            <!-- <form action="" id="DeleteModalForm" method="POST">    -->
                            <input type="hidden" name="host_id_" id="host_id_" class="form-control mb-4" value="{{user.id}}" readonly>
                            <input type="hidden" name="userID" id="userID" class="form-control mb-4" readonly>

                            <!-- <div class="col-md-12"> -->
                                <div class="form-group row">
                                    <!-- <label for="fname" class="col-sm-4 text-end control-label col-form-label">&nbsp;</label> -->
                                    <div class="col-sm-12 text-center">
                                        <!-- <div type="text" class="avatar"></div> -->
                                        <img class="profile-img" src="../media/avatar.svg" alt="" style="width:20%;">

                                    </div>
                                </div>                                        
                            <!-- </div> -->

                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname" class="col-sm-4 text-end control-label col-form-label">First Name</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control first_name"></div>
                                    </div>
                                </div>                                        
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Last Name</label>
                                    <div class="col-sm-8">
                                    <div type="text" class="form-control last_name"></div>
                                    </div>
                                </div>                                        
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">DOB</label>
                                    <div class="col-sm-8">                                            
                                    <div type="text" class="form-control dob"></div>
                                    </div>
                                </div>                                        
                            </div>
                            <div class="col-md-6">   
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Address</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control address"></div>
                                    </div>
                                </div>                                        
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Designation</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control designation"></div>
                                    </div>
                                </div>                                        
                            </div>

                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Phone</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control phone"></div>
                                    </div>
                                </div>                                        
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Sex</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control sex"></div>
                                    </div>
                                </div>                                        
                            </div>                                    
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Email2</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control email2"></div>
                                    </div>
                                </div>                                        
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Primary School</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control primary_school"></div>
                                    </div>
                                </div>                                        
                            </div>

                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Secondary School</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control secondary_school"></div>
                                    </div>
                                </div>                                        
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Tertiary School2</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control tertiary_school2"></div>
                                    </div>
                                </div>                                        
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Tertiary School1</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control tertiary_school1"></div>
                                    </div>
                                </div>                                        
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">Marital Status</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control marital_status"></div>
                                    </div>
                                </div>                                        
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label col-form-label">others</label>
                                    <div class="col-sm-8">
                                        <div type="text" class="form-control others"></div>
                                    </div>
                                </div>                                        
                            </div>
                            
                            <div class="col-md-12">
                                <div class="form-group row">
                                    <label for="fname"
                                    class="col-sm-4 text-end control-label-old col-form-label-old">Bio</label>
                                    <div class="col-sm-8">
                                        <div class="form-control bio"></div>
                                    </div>
                                </div>                                        
                            </div>
                                                        
                            
                        </div>
                        
                    </div>
                    <div class="modal-footer">
                        <!-- <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button> -->
                        <button class="btn btn-secondary" id="btn-Delete-Task" 
                        onclick="" type="button" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
            </div>
        </div>






        <div class="modal fade" id="createUser" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="" name="" method="POST" >
                        {% csrf_token %}
                        <div class="form-group row">
                            <label for="username" class="col-sm-4 text-end control-label col-form-label">Username</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" name="username" id="username" placeholder=""/>
                                <div id="invalid-feedback-uname"></div>
                            </div>

                        </div>
                        <div class="form-group row">
                            <label for="email" class="col-sm-4 text-end control-label col-form-label">Email</label>
                            <div class="col-sm-8">
                                <input type="email" class="form-control" name="email" id="email" placeholder=""/>
                                <div class="invalid-feedback-mail"></div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="password" class="col-sm-4 text-end control-label col-form-label">Password</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" name="password" id="password" readonly value="password"/>
                                <div class="invalid-feedback"></div>
                            </div>

                        </div>
                        <div class="form-group row">
                            <label for="usergroup" class="col-sm-4 text-end control-label col-form-label">User Group</label>
                            <div class="col-sm-8">
                                <select class="form-control" name="usergroup" id="usergroup" >
                                    <option value="">Select...</option>
                                    {% for group in groups %}
                                        <option value="{{group.id}}">{{group.name}}</option>                           
                                    {% endfor %}
                                </select>

                                <div class="invalid-feedback-ugrp"></div>
                            </div>
                        </div>
                    </form>    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="addUser" class="btn btn-primary">Add User</button>
                </div>
                </div>
            </div>
        </div>




    {% endblock content %} 



    {% block footerjs %}
    <script src="{% static 'assets/libs/moment/min/moment.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/datatables-net-1-12-1/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/datatables-net-1-12-1/js/dataTables.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/searchpanes-2-0-2/js/dataTables.searchPanes.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/searchpanes-2-0-2/js/searchPanes.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/datatable-net/select-1-4-0/js/dataTables.select.min.js' %}"></script>

    <script src="{% static 'plugins/datatable/buttons-2.2.3/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/buttons-2.2.3/js/buttons.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/ajax/libs/jszip-3-1-3/jszip.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/ajax/libs/pdfmake-0-1-53/pdfmake.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/ajax/libs/pdfmake-0-1-53/vfs_fonts.js' %}"></script>
    <script src="{% static 'plugins/datatable/buttons-2.2.3/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/buttons-2.2.3/js/buttons.print.min.js' %}"></script>
    <script src="{% static 'plugins/datatable/buttons-2.2.3/js/buttons.colVis.min.js' %}"></script>
    <script>
    //   $("#zero_config").DataTable();
    </script>
    <script src="{% static 'js/user/user_data_table.js' %}"></script>

        {#% include "footerjs_extension.html" %#}
        

<script>


$(document).ready(function() {
    // fill_table();
    // $("#createUser").modal();
    $('#createUser').on('shown.bs.modal', function() {  
            // var reference_tag = $(e.relatedTarget); 
            // var fsid = reference_tag.data('id');
            // var modalID = $(this).attr('id');

            $('#invalid-feedback-uname').css("display", "none");
            // $('.invalid-feedback-mail').css("display", "none");
            // $('.invalid-feedback-ugrp').css("display", "none");
            // $('.invalid-feedback-uname').html('Please correct the error');


            $('#addUser').click(function(){
                let username = $('#username').val();
                let email = $('#email').val();
                let password = $('#password').val();
                let usergroup = $('#usergroup').val();
                let csrfmiddlewaretoken = $('input[name="csrfmiddlewaretoken"]').val();

                if(username === ''){
                    $('#invalid-feedback-uname').html('Please correct the error');
                    // $('#invalid-feedback-uname').css("color", "red");
                    // $('#invalid-feedback-uname').css({
                    //     display: "block",
                    //     color: "red",
                    //     });
                        // console.log('hfhfhfh');
                }
                // console.log(username);
               
                $.ajax({
                    type: "POST",
                    url: "{% url 'add-new-user' %}",
                    data: {
                        csrfmiddlewaretoken: csrfmiddlewaretoken,
                        username: username,
                        email: email,
                        password: password,
                        usergroup: usergroup,
                    },
                    datatype: 'json',
                    dataSrc: "",

                    success:function(response) {
                        // console.log(response);
                        if (response['success']){
                            $('#username').val('');
                            $('#password').val('');
                            $('#email').val(''); 
                            // $('#userDatatable').DataTable().destroy();
                            dataTable.ajax.reload(null, false ); // user paging is not reset on reload    
                            tryc("success", "User created successfully !");
                            $('#createUser').modal('hide');
                        }else if (response['exist']){
                            tryc("warning", "User already exists!");
                        }else {
                            tryc("error", "User creation failed!");
                        }
                        
                    },
                    onerror:function(){
                       
                        tryc("error", "User creation failed!");
                    }
                });

            });

    

        });


    $('#ViewUserModal').on('shown.bs.modal', function(e) { 
    //   console.log("ggdgdgdg");   
        var reference_tag = $(e.relatedTarget); 
        var user_id = reference_tag.data('id');
        $('.profile-img').attr('src', "../media/avatar.svg");
        $('.first_name').html('');
        $('.last_name').html('');
        $('.dob').html('');
        $('.address').html(''); 
        $('.designation').html('');
        $('.phone').html('');
        $('.email').html('');
        $('.email2').html('');         
        $('.email').html('');  
        $('.primary_school').html('');
        $('.secondary_school').html('');
        $('.tertiary_school1').html('');
        $('.tertiary_school2').html(''); 
        $('.others').html('');       
        $('.sex').html('');
        $('.marital_status').html('');
        $('.bio').html('');
        $('#ViewUserModal modal-body').html('')
      console.log(user_id);
        $.ajax({
            type: "GET",
            url: "/api/users/"+user_id+"/profile",
            // data: {                   
            //     id: event_id,
            // },
            datatype: 'json',
            dataSrc: "",
            // moment(st).format('LLL');
            beforeSend:function() {
                // setInterval()
                // $('#ViewUserModal modal-body').text('Loading...').delay(5500);

                // setTimeout(function(){
                //     $("#ViewUserModal modal-body").fadeOut(1500);
                // },15000
                    
                // );
                // $('#ViewUserModal modal-body').text('Loading...').show();
                // setTimeout(function() { $('#ViewUserModal modal-body').text('Loading...').hide(); }, 5000);
 
                
            },
            
            success:function(response) {
                // console.log(response);
                // console.log(response['title']);
                if (response.length != 0){
                    // data_autoloader_old();             
                    $('.profile-img').attr('src', response[0]['avatar']);
                    $('.first_name').html(response[0]['first_name']);
                    $('.last_name').html(response[0]['last_name']);
                    $('.dob').html(response[0]['dob']) ;
                    $('.address').html(response[0]['address']);  
                    $('.designation').html(response[0]['designation']);
                    $('.phone').html(response[0]['phone']);
                    $('.email').html(response[0]['email']); 
                    $('.email2').html(response[0]['email2']);         
                    $('.email').html(response[0]['email']);   
                    $('.primary_school').html(response[0]['primary_school']);  
                    $('.secondary_school').html(response[0]['secondary_school']);
                    $('.tertiary_school1').html(response[0]['tertiary_school1']);
                    $('.tertiary_school2').html(response[0]['tertiary_school2']); 
                    $('.others').html(response[0]['others']);         
                    $('.sex').html(response[0]['sex']); 
                    $('.marital_status').html(response[0]['marital_status']); 
                    $('.bio').html(response[0]['bio']); 

                }else{
                    tryc("warning", "Profile yet to be created!");
                }
            },
            onerror:function(){
                tryc("error", "Profile could not be fetched!");
            }
        });



    });
    $(document).ajaxStart(function(){
        $(".loading").css("display", "block");
    });

    $(document).ajaxComplete(function(){
        $(".loading").css("display", "none");
    });


    
});

    

</script>
    {% endblock footerjs %}
